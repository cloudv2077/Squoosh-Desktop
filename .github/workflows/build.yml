name: ğŸš€ Cross-Platform Build & Release

on:
  workflow_dispatch:
  push:
    tags: ['v*']

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            name: Linux
          - os: windows-latest
            platform: windows
            name: Windows
          - os: macos-latest
            platform: mac
            name: macOS
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm install
        
      - name: ğŸ—ï¸ Prepare Build
        run: npm run prebuild
        
      - name: ğŸ”¨ Build for ${{ matrix.name }}
        run: npx electron-builder --${{ matrix.platform }} --publish=never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“‹ Show Build Results
        shell: bash
        run: |
          echo "=== Build completed for ${{ matrix.name }} ==="
          find dist/ -type f -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" 2>/dev/null || echo "No installer files found"
          ls -la dist/ 2>/dev/null || echo "No dist directory"
          
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: squoosh-desktop-${{ matrix.platform }}
          path: dist/
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: ğŸ“¥ Checkout for Release Notes
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          
      - name: ğŸ“‹ List Downloaded Files
        run: |
          echo "=== Downloaded Artifacts Structure ==="
          find ./artifacts -type f | head -20
          echo "=== Installer Files Only ==="
          find ./artifacts -type f \( -name "*Setup*.exe" -o -name "*.dmg" -o -name "*.AppImage" \)
          
      - name: ğŸ§¹ Organize Release Files
        run: |
          mkdir -p ./release-files
          echo "=== Moving installer files to release directory ==="
          
          # Move Windows installers (only Setup files, not elevate.exe or temp files)
          find ./artifacts -name "*Setup*.exe" -exec cp {} ./release-files/ \;
          
          # Move macOS installers  
          find ./artifacts -name "*.dmg" -exec cp {} ./release-files/ \;
          
          # Move Linux installers
          find ./artifacts -name "*.AppImage" -exec cp {} ./release-files/ \;
          
          echo "=== Final release files ==="
          ls -la ./release-files/
          
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./release-files/*
          name: "Squoosh Desktop ${{ github.ref_name }}"
          body: |
            ğŸ‰ **Squoosh Desktop ${{ github.ref_name }}**
            
            ğŸ“¦ **ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…:**
            
            - ğŸªŸ **Windows**: `*Setup*x64.exe` (64ä½) / `*Setup*ia32.exe` (32ä½)  
            - ğŸ **macOS**: `*.dmg` (Intel) / `*arm64.dmg` (Apple Silicon)
            - ğŸ§ **Linux**: `*.AppImage` (x64) / `*arm64.AppImage` (ARM64)
            
            âœ¨ **ä¸»è¦åŠŸèƒ½:**
            - æ™ºèƒ½å¯åŠ¨ç³»ç»Ÿ - è‡ªåŠ¨æ£€æµ‹Electronï¼Œä¼˜é›…é™çº§åˆ°æµè§ˆå™¨
            - è·¨å¹³å°æ”¯æŒ - Windowsã€macOSã€Linuxå…¨è¦†ç›–
            - é›¶å¤–éƒ¨ä¾èµ– - çº¯Node.jså®ç°
            - å¤šæ¶æ„æ”¯æŒ - x64ã€ARM64ã€ia32åŸç”Ÿæ”¯æŒ
            
            ğŸš€ **ä½¿ç”¨æ–¹æ³•:** ä¸‹è½½å¯¹åº”å¹³å°å®‰è£…åŒ… â†’ å®‰è£… â†’ å¯åŠ¨å³å¯ä½¿ç”¨å®Œæ•´çš„å›¾ç‰‡å‹ç¼©åŠŸèƒ½
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
