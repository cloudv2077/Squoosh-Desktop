name: ğŸš€ Cross-Platform Build & Release

on:
  workflow_dispatch:
  push:
    tags: ['v*']

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            name: Linux
          - os: windows-latest
            platform: windows
            name: Windows
          - os: macos-latest
            platform: mac
            name: macOS
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm install
        
      - name: ğŸ—ï¸ Prepare Build
        run: npm run prebuild
        
      - name: ğŸ”¨ Build for ${{ matrix.name }}
        run: npx electron-builder --${{ matrix.platform }} --publish=never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“‹ Show Build Results
        shell: bash
        run: |
          echo "=== Build completed for ${{ matrix.name }} ==="
          find dist/ -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" \) 2>/dev/null || echo "No installer files found"
          ls -la dist/ 2>/dev/null || echo "No dist directory"
          
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: squoosh-desktop-${{ matrix.platform }}
          path: dist/
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: ğŸ“¥ Checkout for Release Notes
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          
      - name: ğŸ“‹ List Downloaded Files
        run: |
          echo "=== Downloaded Artifacts ==="
          find ./artifacts -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) || echo "No installer files found"
          echo "=== All Files ==="
          find ./artifacts -type f | head -20
          
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/**/*.exe
            ./artifacts/**/*.dmg
            ./artifacts/**/*.AppImage
            ./artifacts/**/*.deb
            ./artifacts/**/*.rpm
          generate_release_notes: false
          name: "Squoosh Desktop ${{ github.ref_name }}"
          body: |
            # ğŸ‰ Squoosh Desktop ${{ github.ref_name }}
            
            ## ğŸ“¦ æ™ºèƒ½è·¨å¹³å°æ¡Œé¢å›¾ç‰‡å‹ç¼©å·¥å…·
            
            åŸºäºGoogle Squooshçš„å®Œæ•´æ¡Œé¢åº”ç”¨ï¼Œæä¾›æ™ºèƒ½å¯åŠ¨ç³»ç»Ÿå’Œé›¶ä¾èµ–æ¶æ„ã€‚
            
            ### ğŸ“¥ ä¸‹è½½å®‰è£…åŒ…
            
            | å¹³å° | æ–‡ä»¶ç±»å‹ | è¯´æ˜ |
            |------|---------|------|
            | ğŸªŸ **Windows** | `.exe` | NSISå®‰è£…ç¨‹åºï¼Œæ”¯æŒx64å’Œx86 |
            | ğŸ **macOS** | `.dmg` | æ‹–æ‹½å®‰è£…åŒ…ï¼Œæ”¯æŒIntelå’ŒApple Silicon |
            | ğŸ§ **Linux** | `.AppImage` | ç›´æ¥è¿è¡Œæ–‡ä»¶ï¼Œæ”¯æŒx64å’ŒARM64 |
            
            ### âœ¨ æ ¸å¿ƒç‰¹æ€§
            
            - ğŸ¯ **æ™ºèƒ½å¯åŠ¨**: Electron + HTTPæœåŠ¡å™¨åŒé‡ä¿éšœ
            - ğŸŒ **é›¶ä¾èµ–**: çº¯Node.jså†…ç½®æ¨¡å—ï¼Œæ— ç¬¬ä¸‰æ–¹ä¾èµ–
            - ğŸ”„ **ä¼˜é›…é™çº§**: ç½‘ç»œé—®é¢˜æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼
            - ğŸ–¥ï¸ **çœŸæ­£æ¡Œé¢ä½“éªŒ**: åŸç”Ÿçª—å£æˆ–æµè§ˆå™¨åº”ç”¨æ¨¡å¼
            - ğŸ“± **å®Œæ•´åŠŸèƒ½**: ä¿æŒæ‰€æœ‰Google Squooshç‰¹æ€§
            - ğŸ›¡ï¸ **ç¦»çº¿å¯ç”¨**: å®Œæ•´çš„æœ¬åœ°é™æ€æ–‡ä»¶æ”¯æŒ
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            
            #### æ–¹å¼ä¸€ï¼šä¸‹è½½å®‰è£…åŒ…ï¼ˆæ¨èï¼‰
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            2. å®‰è£…åç›´æ¥è¿è¡Œ
            3. äº«å—å®Œæ•´æ¡Œé¢ä½“éªŒ
            
            #### æ–¹å¼äºŒï¼šæºç è¿è¡Œ
            ```bash
            git clone https://github.com/cloudv2077/Squoosh-Desktop.git
            cd Squoosh-Desktop
            npm install
            ./start.sh          # macOS/Linux
            start.bat           # Windows
            ```
            
            ### ğŸ”§ æŠ€æœ¯äº®ç‚¹
            
            - **ç½‘ç»œé—®é¢˜è§£å†³**: ç»•è¿‡Electronä¸‹è½½è¶…æ—¶é—®é¢˜
            - **å¤šæ¶æ„æ”¯æŒ**: ARM64å’Œx64åŸç”Ÿæ”¯æŒ
            - **æ™ºèƒ½ç«¯å£æ£€æµ‹**: è‡ªåŠ¨é¿å…ç«¯å£å†²çª
            - **WASMå®Œæ•´æ”¯æŒ**: æ‰€æœ‰å›¾ç‰‡ç¼–è§£ç å™¨æ­£å¸¸å·¥ä½œ
            
            ---
            
            ğŸ’¡ **æç¤º**: å³ä½¿é‡åˆ°ç½‘ç»œé—®é¢˜ï¼Œæ™ºèƒ½å¯åŠ¨ç³»ç»Ÿä¹Ÿä¼šç¡®ä¿æ‚¨èƒ½æ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ï¼
            
            ğŸŒŸ **Star this repo if you find it useful!**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
